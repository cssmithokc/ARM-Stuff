{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "assetLocationURI": {
            "type": "string"
        },
        "resourceGroupsRegion": { // Region to use when creating resource groups.  May not be the same as the region to which resources are deployed
            "type": "string",
            "defaultValue": "East US 2",
            "metadata": {
                "description": "Region where resouce groups will be created.  May not be the same as the region to which resources are deployed"
            },
            "allowedValues": [
                "East Asia",
                "Southeast Asia",
                "Central US",
                "East US",
                "East US 2",
                "West US",
                "North Central US",
                "South Central US",
                "North Europe",
                "West Europe",
                "Japan West",
                "Japan East",
                "Brazil South",
                "Australia East",
                "Australia Southeast",
                "South India",
                "Central India",
                "West India",
                "Canada Central",
                "Canada East",
                "UK South",
                "UK West",
                "West Central US",
                "West US 2",
                "Korea Central",
                "Korea South",
                "France Central",
                "France South",
                "Australia Central",
                "Australia Central 2",
                "UAE Central",
                "UAE North",
                "South Africa North",
                "South Africa West",
                "Switzerland North",
                "Switzerland West",
                "Germany North",
                "Germany West Central",
                "Norway West",
                "Norway East",
                "Brazil Southeast"
            ]
        },

        //Resource Group for the network resources
        "networkResourceGroup_Name": {
            "type": "string"
        },
        "networkResourceGroup_Tags": {
            "type": "object",
            "defaultValue": ""
        },

        //Resource Group for the storage account
        "storageResourceGroup_Name": {
            "type": "string"
        },
        "storageResourceGroup_Tags": {
            "type": "object",
            "defaultValue": ""
        },
        
        //Hub VNet
        "hubVnet_Name": {
            "type": "String"
        },
        "hubVnet_AddressSpace": {
            "type": "string"
        },
        "hubVnet_gatewaySubnet_AddressSpace": {
            "type": "string"
        },
        "hubVnet_azureFirewallSubnet_AddressSpace": {
            "type": "string"
        },
        "hubVnet_azureBastionSubnet_AddressSpace": {
            "type": "string"
        },
        "hubVnet_subnet1_Name": {
            "type": "string"
        },
        "hubVnet_subnet1_AddressSpace": {
            "type": "string"
        },
        "hubVnet_subnet2_Name": {
            "type": "string"
        },
        "hubVnet_subnet2_AddressSpace": {
            "type": "string"
        },

        //Spoke 1 VNet
        "spoke1Vnet_Name": {
            "type": "String"
        },
        "spoke1Vnet_AddressSpace": {
            "type": "string"
        },
        "spoke1Vnet_subnet1_Name": {
            "type": "string"
        },
        "spoke1Vnet_subnet1_AddressSpace": {
            "type": "string"
        },
        "spoke1Vnet_subnet2_Name": {
            "type": "string"
        },
        "spoke1Vnet_subnet2_AddressSpace": {
            "type": "string"
        },
        "spoke1Vnet_subnet3_Name": {
            "type": "string"
        },
        "spoke1Vnet_subnet3_AddressSpace": {
            "type": "string"
        },

        //Spoke 2 VNet
        "spoke2Vnet_Name": {
            "type": "String"
        },
        "spoke2Vnet_AddressSpace": {
            "type": "string"
        },
        "spoke2Vnet_subnet1_Name": {
            "type": "string"
        },
        "spoke2Vnet_subnet1_AddressSpace": {
            "type": "string"
        },
        "spoke2Vnet_subnet2_Name": {
            "type": "string"
        },
        "spoke2Vnet_subnet2_AddressSpace": {
            "type": "string"
        },
        "spoke2Vnet_subnet3_Name": {
            "type": "string"
        },
        "spoke2Vnet_subnet3_AddressSpace": {
            "type": "string"
        },

        //Storage account for NSG flow logs
        "storageAccount_Name": {
            "type": "string"
        },
        "storageAccount_retentionDays": {
            "type": "int"
        }
    },
    "variables": {
        "constants": {
            "location": "[deployment().location]",
            "templateLocationURI": "[concat(parameters('assetLocationURI'), 'Templates/')]",
            "storageAccountRetentionDays": 30,
            "networkWatcherName": "[concat('NetworkWatcher_', variables('azureRegion')[deployment().location])]"
        },
        "deploymentName": "[deployment().name]",
        "deploymentNames": {
            "hubVNet": "[concat(variables('deploymentName'), '-HubVNet')]",
            "spoke1VNet": "[concat(variables('deploymentName'), '-Spoke1VNet')]",
            "spoke2VNet": "[concat(variables('deploymentName'), '-Spoke2VNet')]",
            "vneetPeer": "[concat(variables('deploymentName'), '-VNet-Peer-')]",
            "storageAccount": "[concat(variables('deploymentName'), '-Storage')]",
            "networkWatcher": "[concat(variables('deploymentName'), '-NetworkWatcher')]"
        },
        "azureRegion": {
            "East Asia":"eastasia",
            "Southeast Asia":"southeastasia",
            "Central US":"centralus",
            "East US":"eastus",
            "East US 2":"eastus2",
            "West US":"westus",
            "North Central US":"northcentralus",
            "South Central US":"southcentralus",
            "North Europe":"northeurope",
            "West Europe":"westeurope",
            "Japan West":"japanwest",
            "Japan East":"japaneast",
            "Brazil South":"brazilsouth",
            "Australia East":"australiaeast",
            "Australia Southeast":"australiasoutheast",
            "South India":"southindia",
            "Central India":"centralindia",
            "West India":"westindia",
            "Canada Central":"canadacentral",
            "Canada East":"canadaeast",
            "UK South":"uksouth",
            "UK West":"ukwest",
            "West Central US":"westcentralus",
            "West US 2":"westus2",
            "Korea Central":"koreacentral",
            "Korea South":"koreasouth",
            "France Central":"francecentral",
            "France South":"francesouth",
            "Australia Central":"australiacentral",
            "Australia Central 2":"australiacentral2",
            "UAE Central":"uaecentral",
            "UAE North":"uaenorth",
            "South Africa North":"southafricanorth",
            "South Africa West":"southafricawest",
            "Switzerland North":"switzerlandnorth",
            "Switzerland West":"switzerlandwest",
            "Germany North":"germanynorth",
            "Germany West Central":"germanywestcentral",
            "Norway West":"norwaywest",
            "Norway East":"norwayeast",
            "Brazil Southeast":"brazilsoutheast"
        }
    },
    "functions": [
        {
            "namespace": "function",
            "members": {
                // This function appends -NSG onto the supplied parameter which is intended to be the subnet name
                "nsgName": {
                    "parameters": [
                        {
                            "name": "subnetName",
                            "type": "string"
                        }
                    ],
                    "output": {
                        "value": "[concat(parameters('subnetName'), '-NSG')]",
                        "type": "string"
                    }
                }
            }
        }
    ],
    "resources": [

        //Network resource Group
        {
            "comments": "Network resource Group",
            "name": "[parameters('networkResourceGroup_Name')]",
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2021-04-01",
            "location": "[parameters('resourceGroupsRegion')]",
            "tags": "[parameters('networkResourceGroup_Tags')]"
        },

        //Storage resource group
        {
            "comments": "Storage resource Group",
            "name": "[parameters('storageResourceGroup_Name')]",
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2021-04-01",
            "location": "[parameters('resourceGroupsRegion')]",
            "tags": "[parameters('storageResourceGroup_Tags')]"
        },

        //VNets
        {
            "comments": "Hub VNet",
            "name": "[variables('deploymentNames').hubVNet]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "resourceGroup": "[parameters('networkResourceGroup_Name')]",
            "dependsOn": [
                "[parameters('networkResourceGroup_Name')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('constants').templateLocationURI, 'hubVNet.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    //VNet
                    "vnet_Name": {"value": "[parameters('hubVnet_Name')]"},
                    "vnet_AddressSpace": {"value": "[parameters('hubVnet_AddressSpace')]"},
                    "vnet_Location": {"value": "[variables('constants').location]"},
                    //Subnets
                    "subnet_gatewaySubnet_AddressSpace": {"value": "[parameters('hubVnet_gatewaySubnet_AddressSpace')]"},
                    "subnet_azureFirewallSubnet_AddressSpace": {"value": "[parameters('hubVnet_azureFirewallSubnet_AddressSpace')]"},
                    "subnet_azureBastionSubnet_AddressSpace": {"value": "[parameters('hubVnet_azureBastionSubnet_AddressSpace')]"},
                    "subnet_subnet1_Name": {"value": "[parameters('hubVnet_subnet1_Name')]"},
                    "subnet_subnet1_AddressSpace": {"value": "[parameters('hubVnet_subnet1_AddressSpace')]"},
                    "subnet_subnet2_Name": {"value": "[parameters('hubVnet_subnet2_Name')]"},
                    "subnet_subnet2_AddressSpace": {"value": "[parameters('hubVnet_subnet2_AddressSpace')]"},
                    //NSGs
                    "nsg_subnet1_Name": {"value": "[function.nsgName(parameters('hubVnet_subnet1_Name'))]"},
                    "nsg_subnet2_Name": {"value": "[function.nsgName(parameters('hubVnet_subnet2_Name'))]"}
                }
            }
        },
        {
            "comments": "Spoke 1 VNet",
            "name": "[variables('deploymentNames').spoke1VNet]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "resourceGroup": "[parameters('networkResourceGroup_Name')]",
            "dependsOn": [
                "[parameters('networkResourceGroup_Name')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('constants').templateLocationURI, 'spokeVNet.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    //VNet
                    "vnet_Name": {"value": "[parameters('spoke1Vnet_Name')]"},
                    "vnet_AddressSpace": {"value": "[parameters('spoke1Vnet_AddressSpace')]"},
                    "vnet_Location": {"value": "[variables('constants').location]"},
                    //Subnets
                    "subnet_subnet1_Name": {"value": "[parameters('spoke1Vnet_subnet1_Name')]"},
                    "subnet_subnet1_AddressSpace": {"value": "[parameters('spoke1Vnet_subnet1_AddressSpace')]"},
                    "subnet_subnet2_Name": {"value": "[parameters('spoke1Vnet_subnet2_Name')]"},
                    "subnet_subnet2_AddressSpace": {"value": "[parameters('spoke1Vnet_subnet2_AddressSpace')]"},
                    "subnet_subnet3_Name": {"value": "[parameters('spoke1Vnet_subnet3_Name')]"},
                    "subnet_subnet3_AddressSpace": {"value": "[parameters('spoke1Vnet_subnet3_AddressSpace')]"},
                    //NSGs
                    "nsg_subnet1_Name": {"value": "[function.nsgName(parameters('spoke1Vnet_subnet1_Name'))]"},
                    "nsg_subnet2_Name": {"value": "[function.nsgName(parameters('spoke1Vnet_subnet2_Name'))]"},
                    "nsg_subnet3_Name": {"value": "[function.nsgName(parameters('spoke1Vnet_subnet3_Name'))]"}
                }
            }
        },
        {
            "comments": "Spoke 2 VNet",
            "name": "[variables('deploymentNames').spoke2VNet]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "resourceGroup": "[parameters('networkResourceGroup_Name')]",
            "dependsOn": [
                "[parameters('networkResourceGroup_Name')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('constants').templateLocationURI, 'spokeVNet.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    //VNet
                    "vnet_Name": {"value": "[parameters('spoke2Vnet_Name')]"},
                    "vnet_AddressSpace": {"value": "[parameters('spoke2Vnet_AddressSpace')]"},
                    "vnet_Location": {"value": "[variables('constants').location]"},
                    //Subnets
                    "subnet_subnet1_Name": {"value": "[parameters('spoke2Vnet_subnet1_Name')]"},
                    "subnet_subnet1_AddressSpace": {"value": "[parameters('spoke2Vnet_subnet1_AddressSpace')]"},
                    "subnet_subnet2_Name": {"value": "[parameters('spoke2Vnet_subnet2_Name')]"},
                    "subnet_subnet2_AddressSpace": {"value": "[parameters('spoke2Vnet_subnet2_AddressSpace')]"},
                    "subnet_subnet3_Name": {"value": "[parameters('spoke2Vnet_subnet3_Name')]"},
                    "subnet_subnet3_AddressSpace": {"value": "[parameters('spoke2Vnet_subnet3_AddressSpace')]"},
                    //NSGs
                    "nsg_subnet1_Name": {"value": "[function.nsgName(parameters('spoke2Vnet_subnet1_Name'))]"},
                    "nsg_subnet2_Name": {"value": "[function.nsgName(parameters('spoke2Vnet_subnet2_Name'))]"},
                    "nsg_subnet3_Name": {"value": "[function.nsgName(parameters('spoke2Vnet_subnet3_Name'))]"}
                }
            }
        },

        //VNet Peerings
        {
            "comments": "Hub to Spoke 1",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[concat(variables('deploymentNames').vneetPeer, 'Hub-Spoke1')]",
            "resourceGroup": "[parameters('networkResourceGroup_Name')]",
            "dependsOn": [
                "[variables('deploymentNames').hubVNet]",
                "[variables('deploymentNames').spoke1VNet]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "resources": [
                        {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "name": "[concat(parameters('hubVnet_Name'), '/', parameters('hubVnet_Name'), '_to_', parameters('spoke1Vnet_Name'))]",
                            "apiVersion": "2020-11-01",
                            "properties": {
                                "remoteVirtualNetwork": {
                                    "id": "[reference(variables('deploymentNames').spoke1VNet).outputs.vnetID.value]"
                                },
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteAddressSpace": {
                                    "addressPrefixes": [
                                        "[parameters('spoke1Vnet_AddressSpace')]"
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "comments": "Hub to Spoke 2",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[concat(variables('deploymentNames').vneetPeer, 'Hub-Spoke2')]",
            "resourceGroup": "[parameters('networkResourceGroup_Name')]",
            "dependsOn": [
                "[variables('deploymentNames').hubVNet]",
                "[variables('deploymentNames').spoke2VNet]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "resources": [
                        {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "name": "[concat(parameters('hubVnet_Name'), '/', parameters('hubVnet_Name'), '_to_', parameters('spoke2Vnet_Name'))]",
                            "apiVersion": "2020-11-01",
                            "properties": {
                                "remoteVirtualNetwork": {
                                    "id": "[reference(variables('deploymentNames').spoke2VNet).outputs.vnetID.value]"
                                },
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteAddressSpace": {
                                    "addressPrefixes": [
                                        "[parameters('spoke2Vnet_AddressSpace')]"
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "comments": "Spoke 1 to Hub",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[concat(variables('deploymentNames').vneetPeer, 'Spoke1-Hub')]",
            "resourceGroup": "[parameters('networkResourceGroup_Name')]",
            "dependsOn": [
                "[variables('deploymentNames').hubVNet]",
                "[variables('deploymentNames').spoke1VNet]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "resources": [
                        {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "name": "[concat(parameters('spoke1Vnet_Name'), '/', parameters('spoke1Vnet_Name'), '_to_', parameters('hubVnet_Name'))]",
                            "apiVersion": "2020-11-01",
                            "properties": {
                                "remoteVirtualNetwork": {
                                    "id": "[reference(variables('deploymentNames').hubVNet).outputs.vnetID.value]"
                                },
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteAddressSpace": {
                                    "addressPrefixes": [
                                        "[parameters('hubVnet_Name')]"
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "comments": " Spoke 2 to Hub",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[concat(variables('deploymentNames').vneetPeer, 'Spoke2-Hub')]",
            "resourceGroup": "[parameters('networkResourceGroup_Name')]",
            "dependsOn": [
                "[variables('deploymentNames').hubVNet]",
                "[variables('deploymentNames').spoke2VNet]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "resources": [
                        {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "name": "[concat(parameters('spoke2Vnet_Name'), '/', parameters('spoke2Vnet_Name'), '_to_', parameters('hubVnet_Name'))]",
                            "apiVersion": "2020-11-01",
                            "properties": {
                                "remoteVirtualNetwork": {
                                    "id": "[reference(variables('deploymentNames').hubVNet).outputs.vnetID.value]"
                                },
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteAddressSpace": {
                                    "addressPrefixes": [
                                        "[parameters('hubVnet_Name')]"
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },

        //Storage accounts for NSG flow logs
        {
            "name": "[variables('deploymentNames').storageAccount]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "resourceGroup": "[parameters('storageResourceGroup_Name')]",
            "dependsOn": [
                "[parameters('storageResourceGroup_Name')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('constants').templateLocationURI, 'storage.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "storageAccount_name": {"value": "[parameters('storageAccount_Name')]"},
                    "storageAccount_location": {"value": "[variables('constants').location]"},
                    "storageAccount_retentionDays": {"value": "[parameters('storageAccount_retentionDays')]"}
                }
            }
        },

        // Network watcher
        {
            "name": "[variables('deploymentNames').networkWatcher]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": [
                        {
                            "type": "microsoft.network/networkwatchers",
                            "apiVersion": "2020-11-01",
                            "name": "[variables('constants').networkWatcherName]",
                            "location": "[variables('constants').location]",
                            "properties": {}
                        }
                    ]
                }

            }
        }
    ],
    "outputs": {}
}